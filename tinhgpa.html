    <!DOCTYPE html>
    <html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Qu·∫£n L√Ω ƒêi·ªÉm GPA To√†n Di·ªán</title>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
        <!-- Th∆∞ vi·ªán Xu·∫•t Excel -->
        <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

        <style>
            :root {
                --primary: #005B96;
                --secondary: #FF7A00;
                --success: #28a745;
                --warning: #ffc107;
                --danger: #dc3545;
                --term-bg: #e3f2fd;
                --light: #f8f9fa;
                --dark: #343a40;
                --shadow: 0 4px 15px rgba(0,0,0,0.1);
            }

            * { box-sizing: border-box; }
            body { font-family: 'Roboto', sans-serif; background: #f0f2f5; color: var(--dark); margin: 0; padding: 20px; display: flex; justify-content: center; }
            
            .container { width: 100%; max-width: 1200px; background: white; border-radius: 15px; box-shadow: var(--shadow); overflow: hidden; display: flex; flex-direction: column; }
            
            /* HEADER */
            .header { background: linear-gradient(135deg, var(--primary), #004a7c); padding: 20px; color: white; text-align: center; }
            .header h1 { margin: 0; font-family: 'Montserrat', sans-serif; font-size: 1.8rem; }

            /* LAYOUT */
            .main-content { padding: 20px; display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
            @media (max-width: 900px) { .main-content { grid-template-columns: 1fr; } }

            /* --- LEFT: INPUT --- */
            .input-card { background: #fff; border: 1px solid #e9ecef; border-radius: 10px; padding: 20px; height: fit-content; }
            .input-card.editing { border: 2px solid var(--warning); position: relative; box-shadow: 0 0 15px rgba(255, 193, 7, 0.2); }
            .input-card.editing::before { content: "ƒêANG S·ª¨A"; position: absolute; top: -10px; left: 20px; background: var(--warning); padding: 2px 10px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; }

            .form-group { margin-bottom: 15px; }
            label { display: block; font-weight: 600; margin-bottom: 5px; color: var(--dark); font-size: 0.9rem; }
            input { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 0.95rem; }
            input:focus { outline: none; border-color: var(--secondary); }

            /* Score Inputs */
            .score-box { background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px dashed #ccc; margin-bottom: 15px; }
            .comp-row { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 8px; align-items: center; margin-bottom: 8px; }
            .comp-row:last-child { margin-bottom: 0; }
            .percent-input { position: relative; }
            .percent-input::after { content: '%'; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #999; font-size: 0.8rem; }

            /* Buttons */
            .btn { width: 100%; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s; }
            .btn-add { background: var(--secondary); color: white; }
            .btn-add:hover { background: #e06c00; }
            .btn-update { background: var(--warning); display: none; }
            .btn-clear { background: #e9ecef; color: #333; }

            /* --- RIGHT: RESULT --- */
            .result-area { display: flex; flex-direction: column; gap: 20px; }

            /* Summary Cards */
            .summary-header { display: flex; gap: 15px; flex-wrap: wrap; }
            .stat-card { flex: 1; background: var(--term-bg); padding: 15px; border-radius: 10px; text-align: center; border-bottom: 3px solid var(--primary); min-width: 120px; }
            .stat-label { font-size: 0.8rem; text-transform: uppercase; color: #555; font-weight: bold; }
            .stat-value { font-size: 1.8rem; font-weight: 800; color: var(--primary); }
            .stat-sub { font-size: 0.85rem; color: #666; margin-top: 5px; }

            /* Term List (Cards) */
            .term-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; }
            .term-card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 10px; text-align: center; transition: transform 0.2s; }
            .term-card:hover { transform: translateY(-3px); border-color: var(--secondary); }
            .term-title { font-weight: bold; color: var(--primary); margin-bottom: 5px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }

            /* Table */
            .table-wrapper { overflow-x: auto; background: white; border-radius: 10px; border: 1px solid #eee; }
            table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
            th { background: #f1f3f5; padding: 12px; text-align: center; white-space: nowrap; font-weight: 700; color: #444; }
            td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle; }
            
            /* Semester Header Row in Table */
            .semester-row { background-color: #fff3e0; font-weight: bold; text-align: left; padding-left: 15px; color: var(--secondary); }

            .badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.75rem; font-weight: bold; }
            .badge-A { background: var(--success); } .badge-B { background: #17a2b8; } 
            .badge-C { background: var(--warning); color: #333; } .badge-D { background: #fd7e14; } .badge-F { background: var(--danger); }

            .btn-icon { width: 28px; height: 28px; border: none; border-radius: 4px; cursor: pointer; margin: 0 2px; }
            .btn-edit { background: #ffecb3; color: #d39e00; }
            .btn-del { background: #ffcdd2; color: #c62828; }
            
            .btn-excel { background: #217346; color: white; width: auto; padding: 10px 20px; display: inline-flex; align-items: center; gap: 5px; float: right; margin-bottom: 10px; }
            .btn-excel:hover { background: #1a5c38; }
        </style>
    </head>
    <body>

    <div class="container">
        <div class="header">
            <h1>H·ªá Th·ªëng Qu·∫£n L√Ω ƒêi·ªÉm GPA</h1>
            <p>Chi ti·∫øt theo H·ªçc k·ª≥ & ƒêi·ªÉm th√†nh ph·∫ßn</p>
            <p>H·ªá th·ªëng kh√¥ng l∆∞u d·ªØ li·ªáu n√™n b·∫°n c·ª© y√™n t√¢m s·ª≠ d·ª•ng t√≠nh nƒÉng nh√©</p>
        </div>

        <div class="main-content">
            <!-- FORM NH·∫¨P LI·ªÜU -->
            <div class="input-card" id="inputForm">
                <!-- Th√¥ng tin SV -->
                <div style="background:#e8f0fe; padding:15px; border-radius:8px; margin-bottom:20px;">
                    <div style="font-weight:bold; color:#1967d2; margin-bottom:10px;">üë§ SINH VI√äN</div>
                    <div class="form-group"><input type="text" id="stdName" placeholder="H·ªç v√† t√™n"></div>
                    <div class="form-group" style="margin-bottom:0;"><input type="text" id="stdID" placeholder="MSSV"></div>
                </div>

                <!-- Form M√¥n h·ªçc -->
                <div style="font-weight:bold; color:var(--primary); margin-bottom:10px; border-bottom:2px solid #eee; padding-bottom:5px;">üìò NH·∫¨P ƒêI·ªÇM</div>
                <input type="hidden" id="editIndex" value="-1">

                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <div style="flex:1;">
                        <label>H·ªçc k·ª≥</label>
                        <input type="number" id="semester" value="1" min="1">
                    </div>
                    <div style="flex:1.5;">
                        <label>S·ªë t√≠n ch·ªâ</label>
                        <input type="number" id="credits" value="3" min="1">
                    </div>
                </div>

                <div class="form-group">
                    <label>T√™n m√¥n h·ªçc</label>
                    <input type="text" id="subject" placeholder="VD: Kinh t·∫ø vi m√¥">
                </div>

                <div class="score-box">
                    <label style="font-size:0.8rem; color:#666; margin-bottom:10px; display:block;">ƒêi·ªÉm s·ªë / Tr·ªçng s·ªë (%)</label>
                    <div class="comp-row">
                        <span>Qu√° tr√¨nh</span>
                        <input type="number" id="s1" placeholder="0-10" step="0.1"><div class="percent-input"><input type="number" id="w1" value="20"></div>
                    </div>
                    <div class="comp-row">
                        <span>Gi·ªØa k·ª≥</span>
                        <input type="number" id="s2" placeholder="0-10" step="0.1"><div class="percent-input"><input type="number" id="w2" value="30"></div>
                    </div>
                    <div class="comp-row">
                        <span>Cu·ªëi k·ª≥</span>
                        <input type="number" id="s3" placeholder="0-10" step="0.1"><div class="percent-input"><input type="number" id="w3" value="50"></div>
                    </div>
                </div>
                
                <div id="errorMsg" style="color:red; font-size:0.8rem; display:none; text-align:center; margin-bottom:10px;">T·ªïng % ph·∫£i l√† 100!</div>

                <button id="btnAdd" class="btn btn-add" onclick="saveSubject()">‚ûï Th√™m m√¥n h·ªçc</button>
                <button id="btnUpdate" class="btn btn-update" onclick="saveSubject()">üíæ L∆∞u c·∫≠p nh·∫≠t</button>
                <button class="btn btn-clear" onclick="resetForm()">L√†m m·ªõi form</button>
            </div>

            <!-- K·∫æT QU·∫¢ -->
            <div class="result-area">
                <!-- 1. T·ªïng quan -->
                <div>
                    <button class="btn btn-excel" onclick="exportExcel()">üì• T·∫£i file Excel</button>
                    <div style="clear:both;"></div>
                </div>

                <div class="summary-header">
                    <div class="stat-card">
                        <div class="stat-label">ƒêi·ªÉm trung b√¨nh h·ªá 4.0</div>
                        <div class="stat-value" id="cpa">0.00</div>
                        <div class="stat-sub" id="cpaRank">---</div>
                    </div>
                    <div class="stat-card" style="background:#fff3e0; border-color:var(--secondary);">
                        <div class="stat-label">ƒêi·ªÉm trung b√¨nh h·ªá 10</div>
                        <div class="stat-value" id="avg10" style="color:var(--secondary)">0.00</div>
                    </div>
                    <div class="stat-card" style="background:#fff;">
                        <div class="stat-label">T·ªïng t√≠n ch·ªâ</div>
                        <div class="stat-value" id="totalCred" style="color:#666;">0</div>
                    </div>
                </div>

                <!-- 2. Ph√¢n t√≠ch K·ª≥ -->
                <div>
                    <h4 style="margin:10px 0; color:#555;">üìä K·∫øt qu·∫£ theo t·ª´ng H·ªçc k·ª≥:</h4>
                    <div id="termList" class="term-list">
                        <div style="grid-column:1/-1; text-align:center; color:#999; font-style:italic;">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>
                    </div>
                </div>

                <!-- 3. B·∫£ng Chi ti·∫øt -->
                <div class="table-wrapper">
                    <table id="gradeTable">
                        <thead>
                            <tr>
                                <th width="35%" style="text-align:left;">M√¥n h·ªçc</th>
                                <th>TC</th>
                                <th>QT - GK - CK</th>
                                <th>T·ªïng(10)</th>
                                <th>H·ªá 4</th>
                                <th>Ch·ªØ</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="7" style="padding:20px; text-align:center; color:#999;">Vui l√≤ng nh·∫≠p m√¥n h·ªçc b√™n tr√°i</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let subjects = []; // L∆∞u tr·ªØ d·ªØ li·ªáu

        // --- 1. LOGIC T√çNH ƒêI·ªÇM ---
        function getGradeInfo(score10) {
            const s = parseFloat(score10);
            if (isNaN(s)) return { char: 'F', scale4: 0.0, rank: 'K√©m', css: 'badge-F' };
            if (s >= 9.0) return { char: 'A+', scale4: 4.0, rank: 'Xu·∫•t s·∫Øc', css: 'badge-A' };
            if (s >= 8.0) return { char: 'A', scale4: 3.5, rank: 'Gi·ªèi', css: 'badge-A' };
            if (s >= 7.0) return { char: 'B+', scale4: 3.0, rank: 'Kh√°', css: 'badge-B' };
            if (s >= 6.0) return { char: 'B', scale4: 2.5, rank: 'TB Kh√°', css: 'badge-B' };
            if (s >= 5.0) return { char: 'C', scale4: 2.0, rank: 'TB', css: 'badge-C' };
            if (s >= 4.0) return { char: 'D+', scale4: 1.5, rank: 'Y·∫øu', css: 'badge-D' };
            if (s >= 3.0) return { char: 'D', scale4: 1.0, rank: 'K√©m', css: 'badge-D' };
            return { char: 'F', scale4: 0.0, rank: 'K√©m', css: 'badge-F' };
        }

        function getRank(gpa) {
            if (gpa >= 3.6) return "Xu·∫•t s·∫Øc";
            if (gpa >= 3.2) return "Gi·ªèi";
            if (gpa >= 2.5) return "Kh√°";
            if (gpa >= 2.0) return "Trung b√¨nh";
            return "Y·∫øu/K√©m";
        }

        // --- 2. X·ª¨ L√ù FORM ---
        function saveSubject() {
            const idx = parseInt(document.getElementById('editIndex').value);
            
            // L·∫•y d·ªØ li·ªáu
            const semester = parseInt(document.getElementById('semester').value) || 1;
            const name = document.getElementById('subject').value || `M√¥n h·ªçc ${subjects.length+1}`;
            const cred = parseInt(document.getElementById('credits').value) || 0;
            
            const s1 = parseFloat(document.getElementById('s1').value)||0, w1 = parseFloat(document.getElementById('w1').value)||0;
            const s2 = parseFloat(document.getElementById('s2').value)||0, w2 = parseFloat(document.getElementById('w2').value)||0;
            const s3 = parseFloat(document.getElementById('s3').value)||0, w3 = parseFloat(document.getElementById('w3').value)||0;

            if ((w1+w2+w3) !== 100) {
                document.getElementById('errorMsg').style.display='block'; return;
            }
            document.getElementById('errorMsg').style.display='none';

            const final10 = Math.round(((s1*w1 + s2*w2 + s3*w3)/100)*10)/10;
            const grade = getGradeInfo(final10);

            const data = {
                id: idx !== -1 ? subjects[idx].id : Date.now(),
                semester, name, cred,
                scores: { s1, s2, s3 }, weights: { w1, w2, w3 },
                final10, scale4: grade.scale4, char: grade.char, css: grade.css
            };

            if (idx !== -1) subjects[idx] = data;
            else subjects.push(data);

            // S·∫Øp x·∫øp: Theo K·ª≥ tƒÉng d·∫ßn -> Theo T√™n
            subjects.sort((a,b) => a.semester - b.semester || a.name.localeCompare(b.name));

            if (idx === -1) {
                // N·∫øu th√™m m·ªõi, gi·ªØ l·∫°i H·ªçc k·ª≥ v√† % ƒë·ªÉ nh·∫≠p ti·∫øp cho nhanh
                document.getElementById('subject').value = '';
                document.getElementById('s1').value = ''; document.getElementById('s2').value = ''; document.getElementById('s3').value = '';
                document.getElementById('subject').focus();
            } else {
                resetForm();
            }
            renderApp();
        }

        // --- 3. RENDER GIAO DI·ªÜN ---
        function renderApp() {
            renderTable();
            renderStats();
        }

        function renderTable() {
            const tbody = document.querySelector('#gradeTable tbody');
            tbody.innerHTML = '';
            if (subjects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="padding:20px; text-align:center; color:#999;">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
                return;
            }

            let currentTerm = null;

            subjects.forEach((s, i) => {
                // N·∫øu chuy·ªÉn sang k·ª≥ m·ªõi -> V·∫Ω h√†ng ti√™u ƒë·ªÅ k·ª≥
                if (s.semester !== currentTerm) {
                    currentTerm = s.semester;
                    const rowHeader = document.createElement('tr');
                    rowHeader.innerHTML = `<td colspan="7" class="semester-row">üìå H·ªåC K·ª≤ ${currentTerm}</td>`;
                    tbody.appendChild(rowHeader);
                }

                const tr = document.createElement('tr');
                const details = `${s.scores.s1}(${s.weights.w1}%) - ${s.scores.s2}(${s.weights.w2}%) - ${s.scores.s3}(${s.weights.w3}%)`;
                
                tr.innerHTML = `
                    <td style="text-align:left;">
                        <div style="font-weight:600; color:var(--primary);">${s.name}</div>
                    </td>
                    <td>${s.cred}</td>
                    <td style="font-size:0.8rem; color:#666;">${details}</td>
                    <td style="font-weight:bold;">${s.final10}</td>
                    <td>${s.scale4}</td>
                    <td><span class="badge ${s.css}">${s.char}</span></td>
                    <td>
                        <button class="btn-icon btn-edit" onclick="editSub(${i})">‚úèÔ∏è</button>
                        <button class="btn-icon btn-del" onclick="delSub(${i})">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderStats() {
            if (subjects.length === 0) {
                ['cpa','avg10','totalCred','cpaRank'].forEach(id=>document.getElementById(id).textContent='0');
                document.getElementById('termList').innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#999;">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>';
                return;
            }

            let totalCred=0, totalP4=0, totalP10=0;
            let termData = {};

            subjects.forEach(s => {
                // T√≠ch l≈©y
                totalCred += s.cred;
                totalP4 += s.scale4 * s.cred;
                totalP10 += s.final10 * s.cred;

                // Theo k·ª≥
                if (!termData[s.semester]) termData[s.semester] = { cred:0, p4:0 };
                termData[s.semester].cred += s.cred;
                termData[s.semester].p4 += s.scale4 * s.cred;
            });

            // Hi·ªÉn th·ªã T·ªïng
            const cpa = (totalP4/totalCred).toFixed(2);
            document.getElementById('cpa').textContent = cpa;
            document.getElementById('avg10').textContent = (totalP10/totalCred).toFixed(2);
            document.getElementById('totalCred').textContent = totalCred;
            document.getElementById('cpaRank').textContent = getRank(cpa);

            // Hi·ªÉn th·ªã Th·∫ª K·ª≥
            const termList = document.getElementById('termList');
            termList.innerHTML = '';
            Object.keys(termData).sort((a,b)=>a-b).forEach(k => {
                const t = termData[k];
                const gpa = (t.p4 / t.cred).toFixed(2);
                termList.innerHTML += `
                    <div class="term-card">
                        <div class="term-title">H·ªçc k·ª≥ ${k}</div>
                        <div style="font-size:1.5rem; font-weight:800; color:#333;">${gpa}</div>
                        <div style="font-size:0.8rem; font-weight:bold; color:${gpa>=3.2 ? 'green' : 'orange'}">${getRank(gpa)}</div>
                        <div style="font-size:0.7rem; color:#888; margin-top:5px;">${t.cred} t√≠n ch·ªâ</div>
                    </div>
                `;
            });
        }

        // --- 4. S·ª¨A / X√ìA ---
        function editSub(index) {
            const s = subjects[index];
            document.getElementById('semester').value = s.semester;
            document.getElementById('subject').value = s.name;
            document.getElementById('credits').value = s.cred;
            ['s1','s2','s3'].forEach(k => document.getElementById(k).value = s.scores[k]);
            ['w1','w2','w3'].forEach(k => document.getElementById(k).value = s.weights[k]);

            document.getElementById('editIndex').value = index;
            document.getElementById('inputForm').classList.add('editing');
            document.getElementById('btnAdd').style.display='none';
            document.getElementById('btnUpdate').style.display='block';
            window.scrollTo({top:0, behavior:'smooth'});
        }

        function delSub(index) {
            if(confirm('X√≥a m√¥n n√†y?')) {
                if (parseInt(document.getElementById('editIndex').value) === index) resetForm();
                subjects.splice(index, 1);
                renderApp();
            }
        }

        function resetForm() {
            document.querySelectorAll('input:not(#stdName):not(#stdID)').forEach(i=>i.value='');
            document.getElementById('semester').value=1; document.getElementById('credits').value=3;
            document.getElementById('w1').value=20; document.getElementById('w2').value=30; document.getElementById('w3').value=50;
            
            document.getElementById('editIndex').value = -1;
            document.getElementById('inputForm').classList.remove('editing');
            document.getElementById('btnAdd').style.display='block';
            document.getElementById('btnUpdate').style.display='none';
            document.getElementById('errorMsg').style.display='none';
        }

        // --- 5. XU·∫§T EXCEL ---
        function exportExcel() {
            if (subjects.length === 0) return alert("Ch∆∞a c√≥ d·ªØ li·ªáu!");
            const name = document.getElementById('stdName').value || "SinhVien";
            const id = document.getElementById('stdID').value || "MSSV";

            const data = [
                ["B·∫¢NG ƒêI·ªÇM CHI TI·∫æT & GPA"],
                ["H·ªç t√™n:", name, "", "MSSV:", id],
                ["CPA T√≠ch l≈©y:", document.getElementById('cpa').textContent, "", "T·ªïng TC:", document.getElementById('totalCred').textContent],
                [""], 
                ["T·ªîNG K·∫æT THEO K·ª≤"],
                ["H·ªçc k·ª≥", "GPA K·ª≥", "X·∫øp lo·∫°i", "S·ªë t√≠n ch·ªâ"]
            ];

            // D·ªØ li·ªáu t·ª´ng k·ª≥
            let termData = {};
            subjects.forEach(s => {
                if (!termData[s.semester]) termData[s.semester] = { cred:0, p4:0 };
                termData[s.semester].cred += s.cred;
                termData[s.semester].p4 += s.scale4 * s.cred;
            });
            Object.keys(termData).sort((a,b)=>a-b).forEach(k => {
                const t = termData[k];
                const gpa = (t.p4/t.cred).toFixed(2);
                data.push([`H·ªçc k·ª≥ ${k}`, gpa, getRank(gpa), t.cred]);
            });

            data.push([""]);
            data.push(["CHI TI·∫æT M√îN H·ªåC"]);
            data.push(["H·ªçc k·ª≥", "M√¥n h·ªçc", "T√≠n ch·ªâ", "Qu√° tr√¨nh", "Gi·ªØa k·ª≥", "Cu·ªëi k·ª≥", "T·ªïng (10)", "H·ªá 4", "ƒêi·ªÉm ch·ªØ"]);

            subjects.forEach(s => {
                data.push([
                    s.semester, s.name, s.cred,
                    `${s.scores.s1} (${s.weights.w1}%)`,
                    `${s.scores.s2} (${s.weights.w2}%)`,
                    `${s.scores.s3} (${s.weights.w3}%)`,
                    s.final10, s.scale4, s.char
                ]);
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{wch:10}, {wch:30}, {wch:8}, {wch:15}, {wch:15}, {wch:15}, {wch:10}, {wch:10}, {wch:10}];
            XLSX.utils.book_append_sheet(wb, ws, "BangDiem");
            XLSX.writeFile(wb, `BangDiem_${name.replace(/\s+/g,'')}.xlsx`);
        }
    </script>

    </body>
    </html>
